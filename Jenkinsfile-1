pipeline {
    agent any


    parameters {
        string(name: 'headers_name',
           defaultValue: 'Lior',
           description: 'Header secret to send to Ansible')
  }

    stages {
        stage('Add Key to Vault') {
            steps {
                // "vault-key-new" is your Jenkins credential ID. 
                // Jenkins loads it into the environment var VAULT_TOKEN.
                withCredentials([string(credentialsId: 'vault-key-new', variable: 'VAULT_TOKEN')]) {
                    sh """
                        curl --header "X-Vault-Token: $VAULT_TOKEN" \
                             --header "Content-Type: application/json" \
                             --request POST \
                             --data '{"data": {"nginx-port": "6789"}}' \
                             http://vault:8200/v1/kv/data/nginx-secrets
                    """
                }
            }
        }

        stage('Read Vault Secret') {
            steps {
                withCredentials([string(credentialsId: 'vault-key-new', variable: 'VAULT_TOKEN')]) {
                    // Pull the JSON from Vault into a local file
                    sh """
                        curl --silent --header "X-Vault-Token: $VAULT_TOKEN" \
                             --request GET \
                             http://vault:8200/v1/kv/data/nginx-secrets > nginx-secrets.json
                        
                    """
                }

                script {
                    
                    def json = readJSON file: 'nginx-secrets.json'
                    def secretPort = json.data.data["nginx-port"]

                    echo "The secret port from Vault is: ${secretPort}"

                    def headerSecret = params.headers_name
                    echo "the secret headers from jenkins parameter is: ${headerSecret}"
                    
                    env.NGINX_PORT_SECRET = secretPort
                    env.NGINX_HEADERS_SECRET = headerSecret
                }
            }
        }

        stage('show ansible ver'){
            steps{
                sh """
                    ansible --version
                    ansible-playbook --version
                    ansible-galaxy --version
                    
                """
            }
        }
        stage('use ansible playbook'){
            steps{
                sh """
                    ansible-playbook -i inventory.ini playbook.yml \
                                      --extra-vars "nginx_port=${NGINX_PORT_SECRET} headers_name=${NGINX_HEADERS_SECRET}" \
                    
                """
            }
        }
        
    }
}
